#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2

cd $BUILD_DIR

# include .files when moving things around
shopt -s dotglob

# move everything pushed into tmp dir so we can prep Factor
mkdir -p $CACHE_DIR/tmp_work
mv * $CACHE_DIR/tmp_work

# keep Procfile
if [ -f $CACHE_DIR/tmp_work/Procfile ]; then
  mv $CACHE_DIR/tmp_work/Procfile .
fi

echo -n "-----> Downloading Factor... "
curl --silent --fail http://rbrainard-public.s3.amazonaws.com/heroku-buildpack-factor/factor.tgz | tar xz
echo "done"

echo -n "-----> Copying pushed code to 'work' dir... "
rm -rf factor/work
mv $CACHE_DIR/tmp_work factor/work
echo "done"
